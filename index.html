<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Metrics Calculators — LOI • IR • Conversion</title>
    <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
<style>
  :root{
    --container-w: 1000px;
    --radius: 14px;
    --radius-sm: 10px;
    --shadow: 0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
    --shadow-sm: 0 4px 14px rgba(0,0,0,.07);
    --brand:#3b82f6;
    --brand-dark:#1d4ed8;
    --ok:#16a34a;
    --ok-soft:#e8f6ee;
    --warn:#f59e0b;
    --danger:#ef4444;
    --bg:#f6f7fb;
    --card:#ffffff;
    --muted:#6b7280;
    --ink:#0f172a;
    --line:#e5e7eb;
    --input-h: 40px;
  }

  html,body{height:100%}
  body{
    margin:0; padding:24px;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    background: radial-gradient(1200px 600px at 10% -10%, #ecf3ff 0%, transparent 60%), var(--bg);
    color:var(--ink);
  }
  .shell{max-width:1000px; margin:0 auto;}

  /* Header */
  .header{display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:18px;}
  .title{font-size:28px; font-weight:800; letter-spacing:.2px; margin:0}
  .subtitle{color:var(--muted); margin:0}

  /* Tabs */
  .tabs{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 18px;}
  .tab{
    appearance:none; border:1px solid #dbe2ff; background:#eef2ff; color:#22306a;
    padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer;
    transition:all .15s ease;
  }
  .tab:hover{transform:translateY(-1px)}
  .tab.active{background:var(--brand); border-color:var(--brand); color:#fff; box-shadow:0 0 0 4px rgba(59,130,246,.15)}

  /* Panels */
  .panel{display:none}
  .panel.active{display:block}

  /* Info + formula */
  details.info{
    background:#fff8e6;
    border:1px solid #ffe2a7;
    border-left:4px solid var(--warn);
    border-radius:10px;
    padding:10px 12px;
    margin:12px 0;
    box-shadow:0 4px 14px rgba(0,0,0,.07);
  }
  details.info > summary{
    cursor:pointer; font-weight:700; color:#8a5a00; list-style:none; outline:none;
  }
  .formula{
    background:#eef7ff; color:#0a3b7a;
    border-left:4px solid var(--brand);
    border:1px solid #dbeafe;
    padding:12px 16px; border-radius:10px;
    margin:12px 0; font-weight:800; text-align:center;
    box-shadow:0 4px 14px rgba(0,0,0,.07);
  }

  /* Batches */
  .batches{display:grid; gap:12px;}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    box-shadow:0 6px 24px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
    padding:16px;
  }
  .card-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;}
  .card-title{font-weight:800; color:#0b1b36}
  .remove{
    appearance:none; border:none; background:#fee2e2; color:#7f1d1d;
    width:36px; height:36px; border-radius:10px; cursor:pointer; font-size:18px; line-height:1;
    display:grid; place-items:center; transition:transform .12s ease, background .12s ease;
  }
  .remove:hover{background:#fecaca; transform:rotate(-6deg)}

  .fields{display:grid; gap:12px; grid-template-columns: repeat(12, 1fr);}
  .cols-2 > .field{grid-column: span 6}
  .cols-3 > .field{grid-column: span 4}
  @media (max-width: 720px){
    .cols-2 > .field, .cols-3 > .field{grid-column: span 12}
  }
  .field{display:grid; gap:6px}
  .label{font-weight:700; color:#344157}
  .input{
    height:var(--input-h); border:1px solid var(--line);
    border-radius:10px; padding:8px 12px; font-size:15px; text-align:center;
    transition:border-color .15s ease, box-shadow .15s ease; background:#fff;
  }
  .input:focus{outline:none; border-color:#a5b4fc; box-shadow:0 0 0 4px rgba(99,102,241,.15)}

  .fab-wrap{position:relative; margin-top:10px}
  .fab{
    position:sticky; bottom:16px; left:100%; transform:translateX(-72px);
    appearance:none; border:none; cursor:pointer;
    background:var(--brand); color:#fff; font-weight:800;
    padding:12px 16px; border-radius:999px; box-shadow:0 6px 24px rgba(0,0,0,.08);
    transition:transform .15s ease, background .15s ease;
  }
  .fab:hover{background:var(--brand-dark); transform:translateX(-72px) translateY(-1px)}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
  .btn{
    appearance:none; border:none; cursor:pointer;
    background:#0f172a; color:#fff; font-weight:800;
    padding:12px 16px; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.07);
    transition:transform .12s ease, background .12s ease;
  }
  .btn.primary{background:var(--brand)}
  .btn:hover{transform:translateY(-1px)}

  .error{
    background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;
    border-left:4px solid var(--danger);
    padding:12px; border-radius:12px; margin:12px 0; font-weight:700;
  }
  .note{
    background:#fff8e6; color:#7a4a00; border:1px solid #ffecb3;
    border-left:4px solid var(--warn);
    padding:12px; border-radius:12px; margin:12px 0; font-weight:600;
  }

  .results{
    background:#e8f6ee;
    border:1px solid #c7eed8;
    border-left:6px solid #16a34a;
    border-radius:14px;
    box-shadow:0 4px 14px rgba(0,0,0,.07);
    margin-top:16px; padding:16px;
  }
  .results h3{margin:0 0 10px; color:#0b3b20; font-size:18px}
  .kpi{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; margin:4px 0 10px;}
  .kpi .big{font-size:32px; font-weight:900; color:#065f46; letter-spacing:.2px;}
  .stats{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:6px;}
  .stat{
    background:#fff; border:1px solid #d1fae5; border-radius:12px; padding:10px 12px;
    display:flex; align-items:center; justify-content:space-between; font-weight:700;
  }
  .stat .label{color:#14532d}
  .stat .value{color:#064e3b}
  @media (max-width: 560px){ .stats{grid-template-columns: 1fr} }
</style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div>
        <h1 class="title">Metrics Calculators</h1>
        <p class="subtitle" id="subtitle-text">LOI Calculator</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Calculators">
      <button class="tab active" role="tab" aria-selected="true" aria-controls="panel-loi" id="tab-loi" data-subtitle="LOI Calculator">LOI</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panel-ir" id="tab-ir" data-subtitle="Incidence Rate Calculator">IR</button>
      <button class="tab" role="tab" aria-selected="false" aria-controls="panel-conv" id="tab-conv" data-subtitle="Conversion Rate Calculator">Conversion</button>
    </div>

    <!-- LOI -->
    <section class="panel active" id="panel-loi" role="tabpanel" aria-labelledby="tab-loi">
      <details class="info" open>
        <summary>Disclaimer</summary>
        This is the weighted average of the median LOI for each batch (subsample), where each batch's median is weighted by its number of completes.
      </details>
      <div class="formula">Weighted LOI = Σ(subsample completes × subsample median loi) / Σ(completes)</div>

      <div id="batches-loi" class="batches"></div>

      <div class="fab-wrap">
        <button class="fab" onclick="addBatch('loi')">+ Add Batch</button>
      </div>

      <div class="actions">
        <button class="btn primary" onclick="calculateLOI()">Calculate LOI</button>
      </div>

      <div id="error-loi"></div>
      <div id="results-loi"></div>
    </section>

    <!-- IR -->
    <section class="panel" id="panel-ir" role="tabpanel" aria-labelledby="tab-ir">
      <details class="info" open>
        <summary>Disclaimer</summary>
        Only include screenouts and quotafuls that were not targetable in the incidence rate calculation.
      </details>
      <div class="formula">IR = Completes / (Completes + Screenouts + Quotafuls)</div>

      <div id="batches-ir" class="batches"></div>

      <div class="fab-wrap">
        <button class="fab" onclick="addBatch('ir')">+ Add Batch</button>
      </div>

      <div class="actions">
        <button class="btn primary" onclick="calculateIR()">Calculate IR</button>
      </div>

      <div id="error-ir"></div>
      <div id="results-ir"></div>
    </section>

    <!-- Conversion -->
    <section class="panel" id="panel-conv" role="tabpanel" aria-labelledby="tab-conv">
      <details class="info" open>
        <summary>Disclaimer</summary>
        For client conversion, use the number of clicks that passed the pre-screener.
      </details>
      <div class="formula">Conversion Rate = Completes / Clicks</div>

      <div id="batches-conv" class="batches"></div>

      <div class="fab-wrap">
        <button class="fab" onclick="addBatch('conv')">+ Add Batch</button>
      </div>

      <div class="actions">
        <button class="btn primary" onclick="calculateConversion()">Calculate Conversion</button>
      </div>

      <div id="error-conv"></div>
      <div id="results-conv"></div>
    </section>
  </div>

<script>
  // Tabs + subtitle
  const subtitleEl = document.getElementById('subtitle-text');
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');
  tabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      tabs.forEach(t=>{t.classList.remove('active'); t.setAttribute('aria-selected','false')});
      panels.forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      tab.setAttribute('aria-selected','true');
      document.getElementById(tab.getAttribute('aria-controls')).classList.add('active');
      subtitleEl.textContent = tab.getAttribute('data-subtitle') || '';
    });
  });

  // Batch builder
  function addBatch(kind){
    const targetId = kind==='loi' ? 'batches-loi' : kind==='ir' ? 'batches-ir' : 'batches-conv';
    const wrap = document.getElementById(targetId);
    const card = document.createElement('div');
    card.className = 'card';

    if(kind==='loi'){
      card.innerHTML = `
        <div class="card-head">
          <div class="card-title">Batch</div>
          <button class="remove" title="Remove batch" onclick="removeBatch(this)">×</button>
        </div>
        <div class="fields cols-2">
          <div class="field">
            <label class="label">Completes</label>
            <input class="input loi-completes" type="number" min="1" step="1" placeholder="e.g., 120">
          </div>
          <div class="field">
            <label class="label">Median LOI (min)</label>
            <input class="input loi-median" type="number" min="0.1" step="0.1" placeholder="e.g., 12.5">
          </div>
        </div>`;
    } else if (kind==='ir'){
      card.innerHTML = `
        <div class="card-head">
          <div class="card-title">Batch</div>
          <button class="remove" title="Remove batch" onclick="removeBatch(this)">×</button>
        </div>
        <div class="fields cols-3">
          <div class="field">
            <label class="label">Completes</label>
            <input class="input ir-completes" type="number" min="0" step="1" placeholder="0">
          </div>
          <div class="field">
            <label class="label">Screenouts</label>
            <input class="input ir-screenouts" type="number" min="0" step="1" placeholder="0">
          </div>
          <div class="field">
            <label class="label">Quotafuls</label>
            <input class="input ir-quotafuls" type="number" min="0" step="1" placeholder="0">
          </div>
        </div>`;
    } else {
      card.innerHTML = `
        <div class="card-head">
          <div class="card-title">Batch</div>
          <button class="remove" title="Remove batch" onclick="removeBatch(this)">×</button>
        </div>
        <div class="fields cols-2">
          <div class="field">
            <label class="label">Completes</label>
            <input class="input conv-completes" type="number" min="0" step="1" placeholder="0">
          </div>
          <div class="field">
            <label class="label">Clicks</label>
            <input class="input conv-clicks" type="number" min="0" step="1" placeholder="0">
          </div>
        </div>`;
    }

    wrap.appendChild(card);
    updateBatchTitles(wrap);
  }

  function removeBatch(btn){
    const card = btn.closest('.card');
    const parent = card.parentElement;
    card.remove();
    updateBatchTitles(parent);
  }

  function updateBatchTitles(container){
    const cards = Array.from(container.querySelectorAll('.card'));
    cards.forEach((c,i)=>{
      const title = c.querySelector('.card-title');
      if(title) title.textContent = `Batch ${i+1}`;
    });
  }

  // LOI calculation (weighted mean of medians)
  function calculateLOI(){
    const err = document.getElementById('error-loi');
    const out = document.getElementById('results-loi');
    err.innerHTML = ''; out.innerHTML = '';

    const rows = Array.from(document.querySelectorAll('#batches-loi .card'));
    if(rows.length===0){ err.innerHTML = '<div class="error">Please add at least one batch.</div>'; return; }

    let totalCompletes = 0, sumWeighted = 0;

    for(const r of rows){
      const completes = parseInt(r.querySelector('.loi-completes')?.value,10);
      const median = parseFloat(r.querySelector('.loi-median')?.value);
      if(!completes || completes<=0 || !median || median<=0){
        err.innerHTML = '<div class="error">Please fill all LOI fields with valid positive numbers.</div>'; return;
      }
      totalCompletes += completes;
      sumWeighted += completes * median;
    }

    const wMean = totalCompletes > 0 ? (sumWeighted / totalCompletes) : 0;

    out.innerHTML = `
      <div class="results">
        <h3>LOI (Weighted Mean of Medians)</h3>
        <div class="kpi"><div class="big">${wMean.toFixed(2)} min</div><div>Σ(subsample completes × subsample median loi) / Σ(completes)</div></div>
        <div class="stats">
          <div class="stat"><span class="label">Total Completes</span><span class="value">${totalCompletes}</span></div>
          <div class="stat"><span class="label">Batches</span><span class="value">${rows.length}</span></div>
        </div>
      </div>`;
  }

  // IR calculation
  function calculateIR(){
    const err = document.getElementById('error-ir');
    const out = document.getElementById('results-ir');
    err.innerHTML = ''; out.innerHTML = '';

    const rows = Array.from(document.querySelectorAll('#batches-ir .card'));
    if(rows.length===0){ err.innerHTML = '<div class="error">Please add at least one batch.</div>'; return; }

    let totC=0, totS=0, totQ=0; let details='';

    for(const r of rows){
      const c = parseInt(r.querySelector('.ir-completes')?.value||'0',10);
      const s = parseInt(r.querySelector('.ir-screenouts')?.value||'0',10);
      const q = parseInt(r.querySelector('.ir-quotafuls')?.value||'0',10);

      if(c===0 && s===0 && q===0){ err.innerHTML = '<div class="error">Each batch must have at least one non-zero value.</div>'; return; }
      if(c<0 || s<0 || q<0){ err.innerHTML = '<div class="error">Values must be zero or positive.</div>'; return; }

      const attempts = c+s+q;
      const rate = attempts>0 ? (c/attempts)*100 : 0;

      totC+=c; totS+=s; totQ+=q;

      details += `<div class="stat"><span class="label">Batch ${rows.indexOf(r)+1} Incidence</span><span class="value">${rate.toFixed(2)}%</span></div>`;
    }

    const totA = totC+totS+totQ;
    const overall = totA>0 ? (totC/totA)*100 : 0;

    out.innerHTML = `
      <div class="results">
        <h3>Incidence Rate</h3>
        <div class="kpi"><div class="big">${overall.toFixed(2)}%</div><div>Overall based on all batches</div></div>
        <div class="stats">
          <div class="stat"><span class="label">Total Completes</span><span class="value">${totC}</span></div>
          <div class="stat"><span class="label">Total Screenouts</span><span class="value">${totS}</span></div>
          <div class="stat"><span class="label">Total Quotafuls</span><span class="value">${totQ}</span></div>
          <div class="stat"><span class="label">Total Attempts</span><span class="value">${totA}</span></div>
          <div class="stat"><span class="label">Batches</span><span class="value">${rows.length}</span></div>
          ${details}
        </div>
      </div>`;
  }

  // Conversion calculation
  function calculateConversion(){
    const err = document.getElementById('error-conv');
    const out = document.getElementById('results-conv');
    err.innerHTML = ''; out.innerHTML = '';

    const rows = Array.from(document.querySelectorAll('#batches-conv .card'));
    if(rows.length===0){ err.innerHTML = '<div class="error">Please add at least one batch.</div>'; return; }

    let totC=0, totK=0; let warn=false; let details='';

    for(const r of rows){
      const c = parseInt(r.querySelector('.conv-completes')?.value||'0',10);
      const k = parseInt(r.querySelector('.conv-clicks')?.value||'0',10);

      if(c===0 && k===0){ err.innerHTML = '<div class="error">Each batch must have at least one non-zero value.</div>'; return; }
      if(c<0 || k<0){ err.innerHTML = '<div class="error">Values must be zero or positive.</div>'; return; }
      if(k>0 && c>k) warn = true;

      const rate = k>0 ? (c/k)*100 : 0;
      details += `<div class="stat"><span class="label">Batch ${rows.indexOf(r)+1} Conversion</span><span class="value">${rate.toFixed(2)}%</span></div>`;

      totC+=c; totK+=k;
    }

    const overall = totK>0 ? (totC/totK)*100 : 0;

    out.innerHTML = `
      ${warn ? '<div class="note"><strong>Check:</strong> Some batches have completes greater than clicks. Verify your inputs.</div>' : ''}
      <div class="results">
        <h3>Conversion Rate</h3>
        <div class="kpi"><div class="big">${overall.toFixed(2)}%</div><div>Overall based on all batches</div></div>
        <div class="stats">
          <div class="stat"><span class="label">Total Completes</span><span class="value">${totC}</span></div>
          <div class="stat"><span class="label">Total Clicks</span><span class="value">${totK}</span></div>
          <div class="stat"><span class="label">Batches</span><span class="value">${rows.length}</span></div>
          ${details}
        </div>
      </div>`;
  }

  // Initialize with one card in each panel
  addBatch('loi'); addBatch('ir'); addBatch('conv');
</script>
</body>
</html>
